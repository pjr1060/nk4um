<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (C) 2010-2011 by Chris Cormack
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to deal
  ~ in the Software without restriction, including without limitation the rights
  ~ to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  ~ copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in
  ~ all copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  ~ OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
  ~ THE SOFTWARE.
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd"
                   logicalFilePath="nk4um/base.xml">

  <property name="user.table" value="nk4um_user_account"/>
  <property name="user.id" value="id"/>

  <changeSet id="user-table" author="chrisc" context="builtin-user">

    <createTable tableName="nk4um_user_account">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="username" type="varchar(255)">
        <constraints unique="true" nullable="false"/>
      </column>
      <column name="password" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="email" type="varchar(255)">
        <constraints unique="true" nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  
  <changeSet id="base" author="chrisc">
    <createTable tableName="nk4um_user_meta">
      <column name="user_account_id" type="bigint">
        <constraints nullable="false" unique="true" primaryKey="true"/>
      </column>
      <column name="display_name" type="varchar(255)">
        <constraints unique="true" nullable="false"/>
      </column>
    </createTable>
    
    <createView viewName="nk4um_user">
      SELECT     ${user.table}.${user.id} AS id,
                 ${user.table}.username,
                 ${user.table}.email,
                 nk4um_user_meta.display_name
      FROM       ${user.table}
      LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=${user.table}.${user.id}
    </createView>
    
    <createTable tableName="nk4um_forum_group">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="title" type="varchar(255)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="description" type="varchar(750)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="display_order" type="int">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <createTable tableName="nk4um_forum">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="forum_group_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="title" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="varchar(750)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="display_order" type="int">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addForeignKeyConstraint baseTableName="nk4um_forum"
                             baseColumnNames="forum_group_id"
                             constraintName="nk4um_forum_forum_group_id"
                             referencedTableName="nk4um_forum_group"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    <addUniqueConstraint constraintName="nk4um_forum_unique_name_in_group"
                         tableName="nk4um_forum"
                         columnNames="forum_group_id,title"/>
    
    <createTable tableName="nk4um_forum_topic">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="forum_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="author_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="posted_date" type="datetime">
        <constraints nullable="false"/>
      </column>
      <column name="title" type="varchar(750)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addForeignKeyConstraint baseTableName="nk4um_forum_topic"
                             baseColumnNames="forum_id"
                             constraintName="nk4um_forum_topic_forum_id"
                             referencedTableName="nk4um_forum"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    <createTable tableName="nk4um_forum_topic_post">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="forum_topic_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="author_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="posted_date" type="datetime">
        <constraints nullable="false"/>
      </column>
      <column name="title" type="varchar(750)">
        <constraints nullable="false"/>
      </column>
      <column name="content" type="clob">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addForeignKeyConstraint baseTableName="nk4um_forum_topic_post"
                             baseColumnNames="forum_topic_id"
                             constraintName="nk4um_forum_topic_topic_forum_topic_id"
                             referencedTableName="nk4um_forum_topic"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
  </changeSet>
  
  <changeSet id="user-activation" author="chrisc" context="builtin-user">
    <createTable tableName="nk4um_user_activation">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="activation_code" type="varchar(750)">
        <constraints nullable="false"/>
      </column>
      <column name="creation_date" type="datetime">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="nk4um_user_activation"
                             baseColumnNames="user_id"
                             constraintName="nk4um_user_activation_user_account_id_fkey"
                             referencedTableName="nk4um_user_account"
                             referencedColumnNames="id"
                             onDelete="CASCADE"
                             onUpdate="CASCADE"/>
    
    <addColumn tableName="nk4um_user_account">
      <column name="activated" type="boolean" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
    </addColumn>
    
    <update tableName="nk4um_user_account" >
      <column name="activated" valueBoolean="true"/>
    </update>
    
    <rollback>
      <dropTable tableName="nk4um_user_activation"/>
      <dropColumn tableName="nk4um_user_account" columnName="activated"/>
    </rollback>
  </changeSet>
  
  <changeSet id="user-activation-update-view" author="chrisc">
    <dropView viewName="nk4um_user"/>
    <createView viewName="nk4um_user">
      SELECT     ${user.table}.${user.id} AS id,
                 ${user.table}.username,
                 ${user.table}.email,
                 nk4um_user_meta.display_name,
                 ${user.table}.activated
      FROM       ${user.table}
      LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=${user.table}.${user.id}
    </createView>
    
    <rollback>
      <dropView viewName="nk4um_user"/>
      <createView viewName="nk4um_user">
        SELECT     ${user.table}.${user.id} AS id,
                   ${user.table}.username,
                   ${user.table}.email,
                   nk4um_user_meta.display_name
        FROM       ${user.table}
        LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=${user.table}.${user.id}
      </createView>
    </rollback>
  </changeSet>
  
  <changeSet id="view-statistics" author="chrisc">
    <createTable tableName="nk4um_ip_address">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="ip_address" type="varchar(255)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>
    
    <createTable tableName="nk4um_user_agent">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="user_agent" type="varchar(750)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>
    
    <createTable tableName="nk4um_topic_view">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="topic_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="ip_address_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="user_agent_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="bigint"/>
      <column name="view_date" type="datetime">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addForeignKeyConstraint baseTableName="nk4um_topic_view"
                             baseColumnNames="topic_id"
                             constraintName="nk4um_topic_view_topic_id"
                             referencedTableName="nk4um_forum_topic"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_topic_view"
                             baseColumnNames="ip_address_id"
                             constraintName="nk4um_topic_view_ip_address_id"
                             referencedTableName="nk4um_ip_address"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_topic_view"
                             baseColumnNames="user_agent_id"
                             constraintName="nk4um_topic_view_user_agent_id"
                             referencedTableName="nk4um_user_agent"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
  </changeSet>
  
  <changeSet author="chrisc" id="user-add-fk">
    <addForeignKeyConstraint baseTableName="nk4um_user_meta"
                             baseColumnNames="user_account_id"
                             constraintName="nk4um_user_meta_user_account_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_topic"
                             baseColumnNames="author_id"
                             constraintName="nk4um_forum_topic_author_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_topic_post"
                             baseColumnNames="author_id"
                             constraintName="nk4um_forum_topic_post_author_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_topic_view"
                             baseColumnNames="user_id"
                             constraintName="nk4um_topic_view_user_account_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
  </changeSet>
  
  <changeSet author="chrisc" id="moderator-and-role">
    <createTable tableName="nk4um_role">
      <column name="name" type="varchar(50)">
        <constraints nullable="false" primaryKey="true" />
      </column>
      <column name="description" type="varchar(100)">
        <constraints nullable="false" />
      </column>
      <column name="parent_role_name" type="varchar(50)"/>
    </createTable>
    <addForeignKeyConstraint baseTableName="nk4um_role"
                             baseColumnNames="parent_role_name"
                             constraintName="nk4um_role_parent_role_name_fkey"
                             referencedTableName="nk4um_role"
                             referencedColumnNames="name"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    
    <sql>
      INSERT INTO nk4um_role (name, description)
      VALUES                 ('User', 'nk4um User');
    </sql>
    <sql>
      INSERT INTO nk4um_role (name,            description,           parent_role_name)
      VALUES                 ('Administrator', 'nk4um Administrator', 'User');
    </sql>
    
    <addColumn tableName="nk4um_user_meta">
      <column name="role_name" type="varchar(50)" defaultValue="User">
        <constraints nullable="false"/>
      </column>
    </addColumn>
    <addForeignKeyConstraint baseTableName="nk4um_user_meta"
                             baseColumnNames="role_name"
                             constraintName="nk4um_user_meta_role_name_fkey"
                             referencedTableName="nk4um_role"
                             referencedColumnNames="name"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    <createTable tableName="nk4um_forum_group_moderator">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="forum_group_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="nk4um_forum_group_moderator"
                             baseColumnNames="forum_group_id"
                             constraintName="nk4um_forum_group_moderator_forum_group_id_fkey"
                             referencedTableName="nk4um_forum_group"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_group_moderator"
                             baseColumnNames="user_id"
                             constraintName="nk4um_forum_group_moderator_user_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addUniqueConstraint tableName="nk4um_forum_group_moderator"
                         columnNames="forum_group_id, user_id"/>
    
    <createTable tableName="nk4um_forum_moderator">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="forum_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="nk4um_forum_moderator"
                             baseColumnNames="forum_id"
                             constraintName="nk4um_forum_moderator_forum_id_fkey"
                             referencedTableName="nk4um_forum"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_moderator"
                             baseColumnNames="user_id"
                             constraintName="nk4um_forum_moderator_user_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addUniqueConstraint tableName="nk4um_forum_moderator"
                         columnNames="forum_id, user_id"/>
    
    <dropView viewName="nk4um_user"/>
    <createView viewName="nk4um_user">
      SELECT     ${user.table}.${user.id} AS id,
                 ${user.table}.username,
                 ${user.table}.email,
                 nk4um_user_meta.display_name,
                 nk4um_user_meta.role_name,
                 ${user.table}.activated
      FROM       ${user.table}
      LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=${user.table}.${user.id}
    </createView>

    <rollback>
      <dropView viewName="nk4um_user"/>
      <createView viewName="nk4um_user">
        SELECT     ${user.table}.${user.id} AS id,
                   ${user.table}.username,
                   ${user.table}.email,
                   nk4um_user_meta.display_name,
                   ${user.table}.activated
        FROM       ${user.table}
        LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=${user.table}.${user.id}
      </createView>
      
      <dropTable tableName="nk4um_forum_moderator"/>
      <dropTable tableName="nk4um_forum_group_moderator"/>
      <dropColumn tableName="nk4um_user_meta" columnName="role_name"/>
      <dropTable tableName="nk4um_role"/>
    </rollback>
  </changeSet>
  
  <changeSet id="topic-status" author="chrisc">
    <createTable tableName="nk4um_topic_status">
      <column name="status" type="varchar(50)">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="display_order" type="int">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="visible" type="boolean">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <insert tableName="nk4um_topic_status">
      <column name="status" value="sticky"/>
      <column name="display_order" valueNumeric="1"/>
      <column name="visible" valueBoolean="true"/>
    </insert>
    <insert tableName="nk4um_topic_status">
      <column name="status" value="active"/>
      <column name="display_order" valueNumeric="2"/>
      <column name="visible" valueBoolean="true"/>
    </insert>
    <insert tableName="nk4um_topic_status">
      <column name="status" value="deleted"/>
      <column name="display_order" valueNumeric="3"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
    
    <addColumn tableName="nk4um_forum_topic">
      <column name="status" type="varchar(50)" defaultValue="active">
        <constraints nullable="false"/>
      </column>
    </addColumn>
    
    <addForeignKeyConstraint baseTableName="nk4um_forum_topic"
                             baseColumnNames="status"
                             constraintName="nk4um_forum_topic_topic_status_fkey"
                             referencedTableName="nk4um_topic_status"
                             referencedColumnNames="status"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    <rollback>
      <dropColumn tableName="nk4um_forum_topic" columnName="status"/>
      <dropTable tableName="nk4um_topic_status"/>
    </rollback>
  </changeSet>
  
  <changeSet id="settings-and-notification" author="chrisc">
    <createTable tableName="nk4um_user_setting">
      <column name="key" type="varchar(50)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="default_value" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <createTable tableName="nk4um_user_user_setting">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" unique="false"/>
      </column>
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="user_setting_key" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="value" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addForeignKeyConstraint baseTableName="nk4um_user_user_setting"
                             baseColumnNames="user_id"
                             constraintName="nk4um_user_user_setting_user_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_user_user_setting"
                             baseColumnNames="user_setting_key"
                             constraintName="nk4um_user_user_setting_user_setting_fkey"
                             referencedTableName="nk4um_user_setting"
                             referencedColumnNames="key"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addUniqueConstraint constraintName="nk4um_user_user_setting_unique_key"
                         tableName="nk4um_user_user_setting"
                         columnNames="user_id,user_setting_key"/>
    
    <createTable tableName="nk4um_notification_type">
      <column name="name" type="varchar(50)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
    </createTable>
    <insert tableName="nk4um_notification_type">
      <column name="name" value="email"/>
    </insert>
    
    <createTable tableName="nk4um_forum_subscription">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" unique="false"/>
      </column>
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="forum_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="notification_type_name" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="nk4um_forum_subscription"
                             baseColumnNames="user_id"
                             constraintName="nk4um_forum_subscription_user_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_subscription"
                             baseColumnNames="notification_type_name"
                             constraintName="nk4um_forum_subscription_notification_type_name_fkey"
                             referencedTableName="nk4um_notification_type"
                             referencedColumnNames="name"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_subscription"
                             baseColumnNames="forum_id"
                             constraintName="nk4um_forum_subscription_forum_id"
                             referencedTableName="nk4um_forum"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    <rollback>
      <dropTable tableName="nk4um_forum_subscription"/>
      <dropTable tableName="nk4um_notification_type"/>
      <dropTable tableName="nk4um_user_user_setting"/>
      <dropTable tableName="nk4um_user_setting"/>
    </rollback>
  </changeSet>

  <changeSet id="post-status" author="chrisc">
    <createTable tableName="nk4um_post_status">
      <column name="status" type="varchar(50)">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="visible" type="boolean">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <insert tableName="nk4um_post_status">
      <column name="status" value="active"/>
      <column name="visible" valueBoolean="true"/>
    </insert>
    <insert tableName="nk4um_post_status">
      <column name="status" value="moderation"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
    <insert tableName="nk4um_post_status">
      <column name="status" value="deleted"/>
      <column name="visible" valueBoolean="false"/>
    </insert>

    <addColumn tableName="nk4um_forum_topic_post">
      <column name="status" type="varchar(50)" defaultValue="active">
        <constraints nullable="false"/>
      </column>
    </addColumn>

    <addForeignKeyConstraint baseTableName="nk4um_forum_topic_post"
                             baseColumnNames="status"
                             constraintName="nk4um_forum_topic_post_post_status_fkey"
                             referencedTableName="nk4um_post_status"
                             referencedColumnNames="status"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>

    <rollback>
      <dropColumn tableName="nk4um_forum_topic_post" columnName="status"/>
      <dropTable tableName="nk4um_post_status"/>
    </rollback>
  </changeSet>

  <changeSet id="ignore-deleted-in-counts" author="chrisc">
    <createView viewName="nk4um_visible_forum_topic">
      SELECT *
      FROM   nk4um_forum_topic
      WHERE  (SELECT  visible
              FROM    nk4um_topic_status
              WHERE   nk4um_topic_status.status=nk4um_forum_topic.status);
    </createView>
    <createView viewName="nk4um_visible_forum_topic_post">
      SELECT id,
             forum_topic_id,
             author_id,
             posted_date,
             title,
             status
      FROM   nk4um_forum_topic_post
      WHERE  (SELECT  visible
              FROM    nk4um_post_status
              WHERE   nk4um_post_status.status=nk4um_forum_topic_post.status)
      AND    (SELECT  visible
              FROM    nk4um_topic_status
              WHERE   nk4um_topic_status.status=(SELECT status
                                                 FROM nk4um_forum_topic
                                                 WHERE id=nk4um_forum_topic_post.forum_topic_id));
    </createView>

    <createView viewName="nk4um_visible_topic_view">
      SELECT *
      FROM   nk4um_topic_view
      WHERE  (SELECT  visible
              FROM    nk4um_topic_status
              WHERE   nk4um_topic_status.status=(SELECT status
                                                 FROM nk4um_forum_topic
                                                 WHERE id=nk4um_topic_view.topic_id));
    </createView>
  </changeSet>

  <changeSet id="empty-topic-not-visible" author="chrisc">
    <dropView viewName="nk4um_visible_forum_topic"/>
    <createView viewName="nk4um_visible_forum_topic">
      SELECT *
      FROM   nk4um_forum_topic
      WHERE  (SELECT  visible
               FROM    nk4um_topic_status
               WHERE   nk4um_topic_status.status=nk4um_forum_topic.status)
      AND    (SELECT count(id)
              FROM   nk4um_forum_topic_post
              WHERE  (SELECT  visible
                      FROM    nk4um_post_status
                      WHERE   nk4um_post_status.status=nk4um_forum_topic_post.status)
              AND     nk4um_forum_topic_post.forum_topic_id=nk4um_forum_topic.id)>0;
    </createView>
  </changeSet>
  
  <changeSet id="joined-date" author="chrisc" context="builtin-user">
    <addColumn tableName="nk4um_user_account">
      <column name="joined_date" type="datetime"/>
    </addColumn>
  </changeSet>
  
  <changeSet id="topic-locked" author="chrisc">
    <addColumn tableName="nk4um_forum_topic">
      <column name="locked" type="boolean" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="post-legacy" author="chrisc">
    <addColumn tableName="nk4um_forum_topic_post">
      <column name="legacy" type="boolean" defaultValueBoolean="false"/>
    </addColumn>
  </changeSet>

  <changeSet id="nullable-topic_view-data" author="chrisc">
    <dropNotNullConstraint tableName="nk4um_topic_view" columnName="ip_address_id"/>
    <dropNotNullConstraint tableName="nk4um_topic_view" columnName="user_agent_id"/>
    <dropNotNullConstraint tableName="nk4um_topic_view" columnName="view_date"/>
  </changeSet>

  <changeSet id="removing-username-field-updateViews" author="chrisc">
    <dropView viewName="nk4um_user"/>
    <createView viewName="nk4um_user">
      SELECT     ${user.table}.${user.id} AS id,
                 ${user.table}.email,
                 nk4um_user_meta.display_name,
                 nk4um_user_meta.role_name,
                 ${user.table}.activated
      FROM       ${user.table}
      LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=${user.table}.${user.id}
    </createView>

    <rollback>
      <dropView viewName="nk4um_user"/>
      <createView viewName="nk4um_user">
        SELECT     ${user.table}.${user.id} AS id,
                   ${user.table}.username,
                   ${user.table}.email,
                   nk4um_user_meta.display_name,
                   nk4um_user_meta.role_name,
                   ${user.table}.activated
        FROM       ${user.table}
        LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=${user.table}.${user.id}
      </createView>
    </rollback>
  </changeSet>
  
  <changeSet id="removing-username-field" author="chrisc" context="builtin-user">
    <dropColumn tableName="nk4um_user_account" columnName="username"/>
  </changeSet>

  <changeSet id="add-user-location-imageUrl" author="chrisc">
    <addColumn tableName="nk4um_user_meta">
      <column name="location" type="varchar(750)"/>
      <column name="image_url" type="varchar(750)"/>
    </addColumn>

    <dropView viewName="nk4um_user"/>
    <createView viewName="nk4um_user">
      SELECT     ${user.table}.${user.id} AS id,
                 ${user.table}.email,
                 nk4um_user_meta.display_name,
                 nk4um_user_meta.role_name,
                 nk4um_user_meta.location,
                 nk4um_user_meta.image_url,
                 ${user.table}.activated
      FROM       ${user.table}
      LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=${user.table}.${user.id}
    </createView>

    <rollback>
      <dropView viewName="nk4um_user"/>
      <createView viewName="nk4um_user">
        SELECT     ${user.table}.${user.id} AS id,
                   ${user.table}.email,
                   nk4um_user_meta.display_name,
                   nk4um_user_meta.role_name,
                   ${user.table}.activated
        FROM       ${user.table}
        LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=${user.table}.${user.id}
      </createView>

      <dropColumn tableName="nk4um_user_account" columnName="location"/>
      <dropColumn tableName="nk4um_user_account" columnName="image_url"/>
    </rollback>
  </changeSet>

  <changeSet id="forum-imageUrl" author="chrisc">
    <addColumn tableName="nk4um_forum">
      <column name="image_url" type="varchar(750)"/>
    </addColumn>
  </changeSet>
  
  <changeSet id="fix-view-performance" author="chrisc">
    <dropView viewName="nk4um_visible_topic_view"/>
    <dropView viewName="nk4um_visible_forum_topic_post"/>
    <dropView viewName="nk4um_visible_forum_topic"/>

    <!-- change topic status -->
    <addColumn tableName="nk4um_topic_status">
      <column name="id" type="serial8"/>
    </addColumn>

    <dropForeignKeyConstraint baseTableName="nk4um_forum_topic" constraintName="nk4um_forum_topic_topic_status_fkey"/>

    <renameColumn tableName="nk4um_forum_topic" oldColumnName="status" newColumnName="status_name"/>

    <addColumn tableName="nk4um_forum_topic">
      <column name="status" type="int8"/>
    </addColumn>

    <update tableName="nk4um_forum_topic">
      <column name="status" valueComputed="(SELECT id FROM nk4um_topic_status WHERE nk4um_topic_status.status=nk4um_forum_topic.status_name)"/>
    </update>

    <dropColumn tableName="nk4um_forum_topic" columnName="status_name"/>

    <dropPrimaryKey tableName="nk4um_topic_status" constraintName="pk_nk4um_topic_status"/>

    <addPrimaryKey tableName="nk4um_topic_status" columnNames="id"/>

    <addForeignKeyConstraint baseTableName="nk4um_forum_topic" baseColumnNames="status"
                             constraintName="nk4um_forum_topic_topic_status_fkey"
                             referencedTableName="nk4um_topic_status" referencedColumnNames="id"/>

    <!-- change post status -->
    <addColumn tableName="nk4um_post_status">
      <column name="id" type="serial8"/>
    </addColumn>

    <dropForeignKeyConstraint baseTableName="nk4um_forum_topic_post" constraintName="nk4um_forum_topic_post_post_status_fkey"/>

    <renameColumn tableName="nk4um_forum_topic_post" oldColumnName="status" newColumnName="status_name"/>

    <addColumn tableName="nk4um_forum_topic_post">
      <column name="status" type="int8"/>
    </addColumn>

    <update tableName="nk4um_forum_topic_post">
      <column name="status" valueComputed="(SELECT id FROM nk4um_post_status WHERE nk4um_post_status.status=nk4um_forum_topic_post.status_name)"/>
    </update>

    <dropColumn tableName="nk4um_forum_topic_post" columnName="status_name"/>

    <dropPrimaryKey tableName="nk4um_post_status" constraintName="pk_nk4um_post_status"/>

    <addPrimaryKey tableName="nk4um_post_status" columnNames="id"/>

    <addForeignKeyConstraint baseTableName="nk4um_forum_topic_post" baseColumnNames="status"
                             constraintName="nk4um_forum_topic_post_post_status_fkey"
                             referencedTableName="nk4um_post_status" referencedColumnNames="id"/>


    <createView viewName="nk4um_visible_forum_topic">
      SELECT *
      FROM   nk4um_forum_topic
      WHERE  (SELECT  visible
               FROM    nk4um_topic_status
               WHERE   nk4um_topic_status.id=nk4um_forum_topic.status)
      AND    (SELECT count(id)
              FROM   nk4um_forum_topic_post
              WHERE  (SELECT  visible
                      FROM    nk4um_post_status
                      WHERE   nk4um_post_status.id=nk4um_forum_topic_post.status)
              AND     nk4um_forum_topic_post.forum_topic_id=nk4um_forum_topic.id)>0;
    </createView>
    <createView viewName="nk4um_visible_forum_topic_post">
      SELECT id,
             forum_topic_id,
             author_id,
             posted_date,
             title,
             status
      FROM   nk4um_forum_topic_post
      WHERE  (SELECT  visible
              FROM    nk4um_post_status
              WHERE   nk4um_post_status.id=nk4um_forum_topic_post.status)
      AND    (SELECT  visible
              FROM    nk4um_topic_status
              WHERE   nk4um_topic_status.id=(SELECT status
                                             FROM nk4um_forum_topic
                                             WHERE id=nk4um_forum_topic_post.forum_topic_id));
    </createView>
    <createView viewName="nk4um_visible_topic_view">
      SELECT *
      FROM   nk4um_topic_view
      WHERE  (SELECT  visible
              FROM    nk4um_topic_status
              WHERE   nk4um_topic_status.id=(SELECT status
                                             FROM nk4um_forum_topic
                                             WHERE id=nk4um_topic_view.topic_id));
    </createView>
  </changeSet>

  <changeSet id="status_not_null" author="chrisc">
    <addNotNullConstraint tableName="nk4um_forum_topic" columnName="status"/>
    <addNotNullConstraint tableName="nk4um_forum_topic_post" columnName="status"/>
  </changeSet>
  
  <changeSet id="topic_cached_view" author="chrisc">
    <dropView viewName="nk4um_visible_topic_view"/>
    <addColumn tableName="nk4um_forum_topic">
      <column name="view_count" type="int8" defaultValueNumeric="0">
        <constraints nullable="false"/>
      </column>
    </addColumn>

    <update tableName="nk4um_forum_topic">
      <column name="view_count" valueComputed="(SELECT count(id) FROM nk4um_topic_view WHERE topic_id=nk4um_forum_topic.id)"/>
    </update>

    <rollback>
      <dropColumn tableName="nk4um_forum_topic" columnName="view_count"/>
    </rollback>
  </changeSet>

  <changeSet id="cache-topic-visible" author="chrisc">
    <addColumn tableName="nk4um_forum_topic">
      <column name="visible" type="boolean" defaultValueBoolean="false"/>
    </addColumn>

    <update tableName="nk4um_forum_topic">
      <column name="visible" valueComputed="(SELECT count(id) FROM nk4um_visible_forum_topic WHERE nk4um_visible_forum_topic.id=nk4um_forum_topic.id)=1"/>
    </update>
    
    <addNotNullConstraint tableName="nk4um_forum_topic" columnName="visible"/>
  </changeSet>

  <changeSet id="cache-topic-visible-view" author="chrisc">
    <createView viewName="nk4um_visible_quick_forum_topic">
      SELECT *
      FROM   nk4um_forum_topic
      WHERE  visible;
    </createView>
  </changeSet>

  <changeSet id="cache-post-visible" author="chrisc">
    <addColumn tableName="nk4um_forum_topic_post">
      <column name="visible" type="boolean" defaultValueBoolean="false"/>
    </addColumn>

    <update tableName="nk4um_forum_topic_post">
      <column name="visible" valueComputed="(SELECT count(id) FROM nk4um_visible_forum_topic_post WHERE nk4um_visible_forum_topic_post.id=nk4um_forum_topic_post.id)=1"/>
    </update>

    <addNotNullConstraint tableName="nk4um_forum_topic_post" columnName="visible"/>
  </changeSet>

  <changeSet id="cache-post-visible-view" author="chrisc">
    <createView viewName="nk4um_visible_quick_forum_topic_post">
      SELECT id,
             forum_topic_id,
             author_id,
             posted_date,
             title,
             status
      FROM   nk4um_forum_topic_post
      WHERE  visible;
    </createView>
  </changeSet>

  <changeSet id="posted_date_indexes" author="chrisc">
    <createIndex tableName="nk4um_forum_topic" indexName="nk4um_forum_topic_posted_date">
      <column name="posted_date"/>
    </createIndex>
    <createIndex tableName="nk4um_forum_topic_post" indexName="nk4um_forum_topic_post_posted_date">
      <column name="posted_date"/>
    </createIndex>
  </changeSet>
</databaseChangeLog>
