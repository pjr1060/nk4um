<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd"
                   logicalFilePath="nk4um/base.xml">
  <changeSet id="user-table" author="chrisc" context="builtin-user">
    <createTable tableName="nk4um_user_account">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="username" type="varchar(255)">
        <constraints unique="true" nullable="false"/>
      </column>
      <column name="password" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="email" type="varchar(255)">
        <constraints unique="true" nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  
  <changeSet id="base" author="chrisc">
    <preConditions>
      <changeSetExecuted id="user-table" author="chrisc" changeLogFile="nk4um/base.xml"/>
    </preConditions>
    
    <createTable tableName="nk4um_user_meta">
      <column name="user_account_id" type="bigint">
        <constraints nullable="false" unique="true" primaryKey="true"/>
      </column>
      <column name="display_name" type="varchar(255)">
        <constraints unique="true" nullable="false"/>
      </column>
    </createTable>
    
    <createView viewName="nk4um_user">
      SELECT     nk4um_user_account.id,
                 nk4um_user_account.username,
                 nk4um_user_account.email,
                 nk4um_user_meta.display_name
      FROM       nk4um_user_account
      LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=nk4um_user_account.id
    </createView>
    
    <createTable tableName="nk4um_forum_group">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="title" type="varchar(255)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="description" type="varchar(750)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="display_order" type="int">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <createTable tableName="nk4um_forum">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="forum_group_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="title" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="varchar(750)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="display_order" type="int">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addForeignKeyConstraint baseTableName="nk4um_forum"
                             baseColumnNames="forum_group_id"
                             constraintName="nk4um_forum_forum_group_id"
                             referencedTableName="nk4um_forum_group"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    <addUniqueConstraint constraintName="nk4um_forum_unique_name_in_group"
                         tableName="nk4um_forum"
                         columnNames="forum_group_id,title"/>
    
    <createTable tableName="nk4um_forum_topic">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="forum_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="author_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="posted_date" type="datetime">
        <constraints nullable="false"/>
      </column>
      <column name="title" type="varchar(750)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addForeignKeyConstraint baseTableName="nk4um_forum_topic"
                             baseColumnNames="forum_id"
                             constraintName="nk4um_forum_topic_forum_id"
                             referencedTableName="nk4um_forum"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    <createTable tableName="nk4um_forum_topic_post">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false" unique="true"/>
      </column>
      <column name="forum_topic_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="author_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="posted_date" type="datetime">
        <constraints nullable="false"/>
      </column>
      <column name="title" type="varchar(750)">
        <constraints nullable="false"/>
      </column>
      <column name="content" type="clob">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addForeignKeyConstraint baseTableName="nk4um_forum_topic_post"
                             baseColumnNames="forum_topic_id"
                             constraintName="nk4um_forum_topic_topic_forum_topic_id"
                             referencedTableName="nk4um_forum_topic"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
  </changeSet>
  
  <changeSet id="user-activation" author="chrisc" context="builtin-user">
    <createTable tableName="nk4um_user_activation">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="activation_code" type="varchar(750)">
        <constraints nullable="false"/>
      </column>
      <column name="creation_date" type="datetime">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="nk4um_user_activation"
                             baseColumnNames="user_id"
                             constraintName="nk4um_user_activation_user_account_id_fkey"
                             referencedTableName="nk4um_user_account"
                             referencedColumnNames="id"
                             onDelete="CASCADE"
                             onUpdate="CASCADE"/>
    
    <addColumn tableName="nk4um_user_account">
      <column name="activated" type="boolean" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
    </addColumn>
    
    <update tableName="nk4um_user_account" >
      <column name="activated" valueBoolean="true"/>
    </update>
    
    <rollback>
      <dropTable tableName="nk4um_user_activation"/>
      <dropColumn tableName="nk4um_user_account" columnName="activated"/>
    </rollback>
  </changeSet>
  
  <changeSet id="user-activation-update-view" author="chrisc" context="builtin-user">
    <dropView viewName="nk4um_user"/>
    <createView viewName="nk4um_user">
      SELECT     nk4um_user_account.id,
                 nk4um_user_account.username,
                 nk4um_user_account.email,
                 nk4um_user_meta.display_name,
                 nk4um_user_account.activated
      FROM       nk4um_user_account
      LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=nk4um_user_account.id
    </createView>
    
    <rollback>
      <dropView viewName="nk4um_user"/>
      <createView viewName="nk4um_user">
        SELECT     nk4um_user_account.id,
                   nk4um_user_account.username,
                   nk4um_user_account.email,
                   nk4um_user_meta.display_name,
        FROM       nk4um_user_account
        LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=nk4um_user_account.id
      </createView>
    </rollback>
  </changeSet>
  
  <changeSet id="view-statistics" author="chrisc">
    <createTable tableName="nk4um_ip_address">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="ip_address" type="varchar(255)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>
    
    <createTable tableName="nk4um_user_agent">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="user_agent" type="varchar(750)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>
    
    <createTable tableName="nk4um_topic_view">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="topic_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="ip_address_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="user_agent_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="bigint"/>
      <column name="view_date" type="datetime">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addForeignKeyConstraint baseTableName="nk4um_topic_view"
                             baseColumnNames="topic_id"
                             constraintName="nk4um_topic_view_topic_id"
                             referencedTableName="nk4um_forum_topic"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_topic_view"
                             baseColumnNames="ip_address_id"
                             constraintName="nk4um_topic_view_ip_address_id"
                             referencedTableName="nk4um_ip_address"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_topic_view"
                             baseColumnNames="user_agent_id"
                             constraintName="nk4um_topic_view_user_agent_id"
                             referencedTableName="nk4um_user_agent"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
  </changeSet>
  
  <changeSet author="chrisc" id="user-add-fk">
    <addForeignKeyConstraint baseTableName="nk4um_user_meta"
                             baseColumnNames="user_account_id"
                             constraintName="nk4um_user_meta_user_account_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_topic"
                             baseColumnNames="author_id"
                             constraintName="nk4um_forum_topic_author_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_topic_post"
                             baseColumnNames="author_id"
                             constraintName="nk4um_forum_topic_post_author_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_topic_view"
                             baseColumnNames="user_id"
                             constraintName="nk4um_topic_view_user_account_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
  </changeSet>
  
  <changeSet author="chrisc" id="moderator-and-role">
    <createTable tableName="nk4um_role">
      <column name="name" type="varchar(50)">
        <constraints nullable="false" primaryKey="true" />
      </column>
      <column name="description" type="varchar(100)">
        <constraints nullable="false" />
      </column>
      <column name="parent_role_name" type="varchar(50)"/>
    </createTable>
    <addForeignKeyConstraint baseTableName="nk4um_role"
                             baseColumnNames="parent_role_name"
                             constraintName="nk4um_role_parent_role_name_fkey"
                             referencedTableName="nk4um_role"
                             referencedColumnNames="name"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    
    <sql>
      INSERT INTO nk4um_role (name, description)
      VALUES                 ('User', 'nk4um User');
    </sql>
    <sql>
      INSERT INTO nk4um_role (name,            description,           parent_role_name)
      VALUES                 ('Administrator', 'nk4um Administrator', 'User');
    </sql>
    
    <addColumn tableName="nk4um_user_meta">
      <column name="role_name" type="varchar(50)" defaultValue="User">
        <constraints nullable="false"/>
      </column>
    </addColumn>
    <addForeignKeyConstraint baseTableName="nk4um_user_meta"
                             baseColumnNames="role_name"
                             constraintName="nk4um_user_meta_role_name_fkey"
                             referencedTableName="nk4um_role"
                             referencedColumnNames="name"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    <createTable tableName="nk4um_forum_group_moderator">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="forum_group_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="nk4um_forum_group_moderator"
                             baseColumnNames="forum_group_id"
                             constraintName="nk4um_forum_group_moderator_forum_group_id_fkey"
                             referencedTableName="nk4um_forum_group"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_group_moderator"
                             baseColumnNames="user_id"
                             constraintName="nk4um_forum_group_moderator_user_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addUniqueConstraint tableName="nk4um_forum_group_moderator"
                         columnNames="forum_group_id, user_id"/>
    
    <createTable tableName="nk4um_forum_moderator">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="forum_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="nk4um_forum_moderator"
                             baseColumnNames="forum_id"
                             constraintName="nk4um_forum_moderator_forum_id_fkey"
                             referencedTableName="nk4um_forum"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_moderator"
                             baseColumnNames="user_id"
                             constraintName="nk4um_forum_moderator_user_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addUniqueConstraint tableName="nk4um_forum_moderator"
                         columnNames="forum_id, user_id"/>
    
    <dropView viewName="nk4um_user"/>
    <createView viewName="nk4um_user">
      SELECT     nk4um_user_account.id,
                 nk4um_user_account.username,
                 nk4um_user_account.email,
                 nk4um_user_meta.display_name,
                 nk4um_user_meta.role_name,
                 nk4um_user_account.activated
      FROM       nk4um_user_account
      LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=nk4um_user_account.id
    </createView>
    
    <rollback>
      <dropView viewName="nk4um_user"/>
      <createView viewName="nk4um_user">
        SELECT     nk4um_user_account.id,
                   nk4um_user_account.username,
                   nk4um_user_account.email,
                   nk4um_user_meta.display_name,
                   nk4um_user_account.activated
        FROM       nk4um_user_account
        LEFT JOIN  nk4um_user_meta ON nk4um_user_meta.user_account_id=nk4um_user_account.id
      </createView>
      
      <dropTable tableName="nk4um_forum_moderator"/>
      <dropTable tableName="nk4um_forum_group_moderator"/>
      <dropColumn tableName="nk4um_user_meta" columnName="role_name"/>
      <dropTable tableName="nk4um_role"/>
    </rollback>
  </changeSet>
  
  <changeSet id="topic-status" author="chrisc">
    <createTable tableName="nk4um_topic_status">
      <column name="status" type="varchar(50)">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="order" type="int">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="visible" type="boolean">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <insert tableName="nk4um_topic_status">
      <column name="status" value="sticky"/>
      <column name="order" valueNumeric="1"/>
      <column name="visible" valueBoolean="true"/>
    </insert>
    <insert tableName="nk4um_topic_status">
      <column name="status" value="active"/>
      <column name="order" valueNumeric="2"/>
      <column name="visible" valueBoolean="true"/>
    </insert>
    <insert tableName="nk4um_topic_status">
      <column name="status" value="deleted"/>
      <column name="order" valueNumeric="3"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
    
    <addColumn tableName="nk4um_forum_topic">
      <column name="status" type="varchar(50)" defaultValue="active">
        <constraints nullable="false"/>
      </column>
    </addColumn>
    
    <addForeignKeyConstraint baseTableName="nk4um_forum_topic"
                             baseColumnNames="status"
                             constraintName="nk4um_forum_topic_topic_status_fkey"
                             referencedTableName="nk4um_topic_status"
                             referencedColumnNames="status"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    <rollback>
      <dropColumn tableName="nk4um_forum_topic" columnName="status"/>
      <dropTable tableName="nk4um_topic_status"/>
    </rollback>
  </changeSet>
  
  <changeSet id="settings-and-notification" author="chrisc">
    <createTable tableName="nk4um_user_setting">
      <column name="key" type="varchar(50)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="default_value" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <createTable tableName="nk4um_user_user_setting">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" unique="false"/>
      </column>
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="user_setting_key" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="value" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addForeignKeyConstraint baseTableName="nk4um_user_user_setting"
                             baseColumnNames="user_id"
                             constraintName="nk4um_user_user_setting_user_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_user_user_setting"
                             baseColumnNames="user_setting_key"
                             constraintName="nk4um_user_user_setting_user_setting_fkey"
                             referencedTableName="nk4um_user_setting"
                             referencedColumnNames="key"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addUniqueConstraint constraintName="nk4um_user_user_setting_unique_key"
                         tableName="nk4um_user_user_setting"
                         columnNames="user_id,user_setting_key"/>
    
    <createTable tableName="nk4um_notification_type">
      <column name="name" type="varchar(50)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
    </createTable>
    <insert tableName="nk4um_notification_type">
      <column name="name" value="email"/>
    </insert>
    
    <createTable tableName="nk4um_forum_subscription">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" unique="false"/>
      </column>
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="forum_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="notification_type_name" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="nk4um_forum_subscription"
                             baseColumnNames="user_id"
                             constraintName="nk4um_forum_subscription_user_id_fkey"
                             referencedTableName="${user.table}"
                             referencedColumnNames="${user.id}"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_subscription"
                             baseColumnNames="notification_type_name"
                             constraintName="nk4um_forum_subscription_notification_type_name_fkey"
                             referencedTableName="nk4um_notification_type"
                             referencedColumnNames="name"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="nk4um_forum_subscription"
                             baseColumnNames="forum_id"
                             constraintName="nk4um_forum_subscription_forum_id"
                             referencedTableName="nk4um_forum"
                             referencedColumnNames="id"
                             onDelete="RESTRICT"
                             onUpdate="RESTRICT"/>
    
    <rollback>
      <dropTable tableName="nk4um_forum_subscription"/>
      <dropTable tableName="nk4um_notification_type"/>
      <dropTable tableName="nk4um_user_user_setting"/>
      <dropTable tableName="nk4um_user_setting"/>
    </rollback>
  </changeSet>
</databaseChangeLog>
