<?xml version="1.0" encoding="UTF-8"?>
<nk4um:page xmlns:nk4um="http://onegch.org.uk/netkernel/nk4um"
            xmlns:xrl="http://netkernel.org/xrl">
  <nk4um:title>nk4um Add Post</nk4um:title>
  <nk4um:heading>nk4um Add Post</nk4um:heading>
  <nk4um:head>
    <script type="text/javascript">
      $(function() {
        jQuery.fn.extend({
          insertAtCaret: function(myValue){
            return this.each(function(i) {
              if (document.selection) {
                this.focus();
                sel = document.selection.createRange();
                sel.text = myValue;
                this.focus();
              }
              else if (this.selectionStart || this.selectionStart == '0') {
                var startPos = this.selectionStart;
                var endPos = this.selectionEnd;
                var scrollTop = this.scrollTop;
                this.value = this.value.substring(0, startPos)+myValue+this.value.substring(endPos,this.value.length);
                this.focus();
                this.selectionStart = startPos + myValue.length;
                this.selectionEnd = startPos + myValue.length;
                this.scrollTop = scrollTop;
              } else {
                this.value += myValue;
                this.focus();
              }
            })
          }
          });

        $("#reply-content").keyup(function () {
          updatePreview();

        });
      
        $("#topicTable").dataTable({
          "bJQueryUI": true,
          "sPaginationType": "full_numbers",
          "aaSorting": [[1,'desc']],
          "aoColumns": [ null,
                         { "sType": "iso-date" }
                       ]
        });

        $(".post-title").prepend("&lt;button class=\"quote-button\"style=\"margin-right: 5px;\">Quote&lt;/button>");

        $(".quote-button").click(function() {
          var post= $(this).parent().parent().parent();
          $("#reply-content").insertAtCaret("&lt;div class=\"reference\">\n" +
                                              "&lt;div class=\"reference-author\">\n" +
                                                "Posted by " + $(".post-author", post).text() + " ([/nk4um/topic/" + $("#topicId").val() + "/index#" + $(".post-anchor", post).attr("name") + " View])" +
                                              "&lt;/div>\n" +
                                              "&lt;div class=\"reference-quote\">\n" +
                                                $("textarea.post-raw", post).val() +
                                              "&lt;/div>\n" +
                                            "&lt;/div>");
          updatePreview();
        });
      });

      function updatePreview() {
        $.post("/nk4um/post/preview", { post : $("#reply-content").val() }, function(data) {
          $("#contentPreview").html(data);
        }, "html");
      }
    </script>
  </nk4um:head>
  <nk4um:breadcrumbs>
    <xrl:include>
      <xrl:identifier>nk4um:web:topic:breadcrumbs</xrl:identifier>
      <xrl:argument name="id">arg:id</xrl:argument>
    </xrl:include>
  </nk4um:breadcrumbs>
  <nk4um:content>
    <input type="hidden" id="topicId" value="arg:id" xrl:eval="value"/>
    <form class="styled-form" action="doAdd" method="POST">
      <div class="form-header">
        <h3>Post Reply</h3>
      </div>
      <div class="form-body">
        <div>
          <label for="title">Title:</label>
          <input type="text" name="title"/>
        </div>
        <div>
          <label for="content">Content:</label>
          <textarea name="content" id="reply-content"/>
        </div>
      </div>
      <div>
        <div class="label">Preview:</div>
        <div class="form-body-content" id="contentPreview" style="width: 620px; margin: 0; margin-bottom: 6px; padding: 4px; border: 1px solid darkGrey; height: 150px; overflow: scroll;">
        </div>
      </div>
      <div class="form-footer">
        <button type="submit">Post Reply</button>
      </div>
    </form>
    <h2>Topic Recap</h2>
    <table id="topicTable"
           class="forumTable"
           xmlns:xrl="http://netkernel.org/xrl">
      <thead>
        <tr>
          <th class="fixedColumn">Poster</th>
          <th class="stretchedColumn">Content</th>
        </tr>
      </thead>
      <tbody class="forumGroup">
        <xrl:include>
          <xrl:identifier>nk4um:web:topic:postList</xrl:identifier>
          <xrl:argument name="id">arg:id</xrl:argument>
        </xrl:include>
      </tbody>
    </table>
  </nk4um:content>
</nk4um:page>
